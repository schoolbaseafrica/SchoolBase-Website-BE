name: Staging Deployment

on:
  workflow_run:
    workflows: ['CI Pipeline (Staging)']
    types:
      - completed
    branches:
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if CI passed
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    env:
      HOST: ${{ secrets.HOST }}
      USERNAME: ${{ secrets.USERNAME }}
      PASSWORD: ${{ secrets.PASSWORD }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23'

      - name: Deploy to Staging
        run: |
          sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$HOST << 'EOF'
            cd ~/open-school/prod/open-school-portal-BE
            git reset --hard
            pm2 stop open-school-be-staging
            git pull origin staging
            npm install
            npm run build
            pm2 restart open-school-be-staging --update-env
          EOF

